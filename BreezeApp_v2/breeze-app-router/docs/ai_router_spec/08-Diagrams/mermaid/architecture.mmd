%%{init: {
  'theme': 'base',
  'themeVariables': {
    'primaryColor': '#4F46E5',
    'primaryTextColor': '#FFFFFF',
    'secondaryColor': '#E5E7EB',
    'tertiaryColor': '#F3F4F6',
    'background': '#FFFFFF',
    'mainBkg': '#4F46E5',
    'secondaryBkg': '#E5E7EB'
  }
}}%%

flowchart LR
    %% UI Layer
    subgraph UI ["🎯 UI 層"]
        UIComp[Activity / ViewModel]
        UIInterface[AI Router Interface]
    end

    %% AI Router Core
    subgraph Router ["🧠 AI Router 核心"]
        Facade[AIRouterFacade]
        Parser[ConfigParser]
        Tracker[UsageTracker]
        Dispatcher[RequestDispatcher]
        CapRouter[CapabilityRouter]
        Registry[RunnerRegistry]
    end

    %% Model Management
    subgraph ModelMgmt ["📦 模型管理"]
        ModelMgr[ModelManager]
        Selector[ModelSelector]
        Scope[ModelScope]
        Loader[ModelLoader]
        Downloader[ModelDownloader]
        ModelReg[ModelRegistry]
    end

    %% Capabilities
    subgraph Capabilities ["🎯 AI 能力"]
        LLM[LLM]
        ASR[ASR]
        TTS[TTS]
        VLM[VLM]
        Guardian[Guardian]
    end

    %% Runners
    subgraph Runners ["🚀 Runner 實作"]
        RunnerLLM[LLMRunner]
        RunnerASR[ASRRunner]
        RunnerTTS[TTSRunner]
        RunnerVLM[VLMRunner]
        RunnerGuardian[GuardianRunner]
    end

    %% Runtime Stack
    subgraph RuntimeStack ["⚙️ 執行引擎"]
        Runtime[RuntimeEngine]
        JNI[JNIBridge]
        NativeLibs[Native Libraries<br/>ONNX/PTE/MediaPipe]
    end

    %% Connections - UI to Router
    UIComp --> UIInterface
    UIInterface --> Facade

    %% Connections - Router Internal
    Facade --> Parser
    Facade --> Tracker
    Facade --> Dispatcher
    Facade --> CapRouter
    
    Parser --> Registry
    Dispatcher --> ModelMgr
    CapRouter --> Registry

    %% Connections - Model Management
    ModelMgr --> Selector
    ModelMgr --> Scope
    ModelMgr --> Loader
    ModelMgr --> Downloader
    ModelMgr --> ModelReg

    %% Connections - Capability to Runners
    CapRouter --> LLM
    CapRouter --> ASR
    CapRouter --> TTS
    CapRouter --> VLM
    CapRouter --> Guardian

    LLM --> RunnerLLM
    ASR --> RunnerASR
    TTS --> RunnerTTS
    VLM --> RunnerVLM
    Guardian --> RunnerGuardian

    %% Connections - Runners to Model Management
    RunnerLLM --> ModelMgr
    RunnerASR --> ModelMgr
    RunnerTTS --> ModelMgr
    RunnerVLM --> ModelMgr
    RunnerGuardian --> ModelMgr

    %% Connections - Runners to Runtime
    RunnerLLM --> Runtime
    RunnerASR --> Runtime
    RunnerTTS --> Runtime
    RunnerVLM --> Runtime
    RunnerGuardian --> Runtime

    %% Connections - Runtime Stack
    Runtime --> JNI
    JNI --> NativeLibs

    %% Styling
    classDef uiClass fill:#3B82F6,stroke:#1E40AF,stroke-width:2px,color:#FFFFFF
    classDef routerClass fill:#6366F1,stroke:#4338CA,stroke-width:2px,color:#FFFFFF
    classDef modelClass fill:#8B5CF6,stroke:#7C3AED,stroke-width:2px,color:#FFFFFF
    classDef capabilityClass fill:#10B981,stroke:#047857,stroke-width:2px,color:#FFFFFF
    classDef runnerClass fill:#F59E0B,stroke:#D97706,stroke-width:2px,color:#FFFFFF
    classDef runtimeClass fill:#EF4444,stroke:#DC2626,stroke-width:2px,color:#FFFFFF

    class UIComp,UIInterface uiClass
    class Facade,Parser,Tracker,Dispatcher,CapRouter,Registry routerClass
    class ModelMgr,Selector,Scope,Loader,Downloader,ModelReg modelClass
    class LLM,ASR,TTS,VLM,Guardian capabilityClass
    class RunnerLLM,RunnerASR,RunnerTTS,RunnerVLM,RunnerGuardian runnerClass
    class Runtime,JNI,NativeLibs runtimeClass 